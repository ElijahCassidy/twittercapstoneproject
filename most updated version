import streamlit as st

st.markdown(
    """
    <style>
    header {visibility: hidden;}
    .stAppViewMain > div:nth-child(1) {padding-top: 0rem;}
    [data-testid="stDecoration"] {display: none;}

    /* Base Background Color - Deep Blue */
    .stApp {
        background-color: #0d47a1;
        color: white;
    }

    .stMarkdown, p, span, label {
        color: #e3f2fd !important;
    }

    /* Standard Buttons - Light Blue Glass Effect */
    div.stButton > button {
        width: 100%;
        background-color: rgba(255, 255, 255, 0.1); 
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-weight: bold;
        transition: all 0.3s ease;
    }

    div.stButton > button:hover {
        background-color: rgba(255, 255, 255, 0.25);
        border-color: #90caf9;
        color: white;
    }

    /* The "Liked" Button - Now a Vibrant Cobalt Blue instead of Red */
    div.stButton > button:first-child[kind="primary"] {
        background-color: #1e88e5 !important;
        color: white !important;
        border: 1px solid #bbdefb !important;
        box-shadow: 0px 0px 10px rgba(30, 136, 229, 0.5);
    }
    
    /* Input fields styling to match blue theme */
    div[data-baseweb="input"], div[data-baseweb="textarea"], div[data-baseweb="select"] {
        background-color: #1565c0 !important;
        border-color: #1976d2 !important;
    }
    </style>
    """,
    unsafe_allow_html=True
)

if 'users' not in st.session_state:
    st.session_state.users = {}
if 'posts' not in st.session_state:
    st.session_state.posts = []
if 'post_id' not in st.session_state:
    st.session_state.post_id = 1
if 'liked_posts' not in st.session_state:
    st.session_state.liked_posts = set()
if 'choice' not in st.session_state:
    st.session_state.choice = "View Feed"
if 'show_menu' not in st.session_state:
    st.session_state.show_menu = False

st.title("BlueBird")

# Main Category Button
if st.button(f"☰ {st.session_state.choice.upper()}", use_container_width=True):
    st.session_state.show_menu = not st.session_state.show_menu

# Sub-menu
if st.session_state.show_menu:
    menu_options = ["View Feed", "Make a Post", "Create User", "Edit Bio"]
    cols = st.columns(len(menu_options))
    for i, tab in enumerate(menu_options):
        if cols[i].button(tab, use_container_width=True):
            st.session_state.choice = tab
            st.session_state.show_menu = False
            st.rerun()

st.divider()

choice = st.session_state.choice

if choice == "Create User":
    st.subheader("Create a New Account")
    new_user = st.text_input("Enter a username")
    new_bio = st.text_area("Enter your bio")
    
    if st.button("Register", use_container_width=True):
        if new_user and new_user not in st.session_state.users:
            st.session_state.users[new_user] = {'bio': new_bio, 'followers': 0}
            st.success(f"User '{new_user}' created!")
        else:
            st.error("Username already exists or is empty.")

elif choice == "Make a Post":
    st.subheader("Share something!")
    if not st.session_state.users:
        st.warning("Please create a user first.")
    else:
        post_user = st.selectbox("Who are you?", list(st.session_state.users.keys()))
        content = st.text_area("What's on your mind?")
        
        if st.button("Post", use_container_width=True):
            new_post = {
                "id": st.session_state.post_id,
                "user": post_user,
                "text": content,
                "likes": 0
            }
            st.session_state.posts.append(new_post)
            st.session_state.post_id += 1
            st.success("Post shared to the feed!")

elif choice == "View Feed":
    st.markdown("### **THE FEED**")
    
    if not st.session_state.posts:
        st.info("No posts yet.")
    else:
        for post in reversed(st.session_state.posts):
            with st.container():
                st.write(f"**@{post['user']}**")
                st.write(post['text'])
                
                is_liked = post['id'] in st.session_state.liked_posts
                
                # The "type" argument triggers the Primary/Secondary CSS logic above
                if st.button(
                    f" ★ Liked ({post['likes']})" if is_liked else f"☆ Like ({post['likes']})", 
                    key=f"like_{post['id']}", 
                    type="primary" if is_liked else "secondary",
                    use_container_width=True
                ):
                    if not is_liked:
                        post['likes'] += 1
                        st.session_state.liked_posts.add(post['id'])
                    else:
                        post['likes'] -= 1
                        st.session_state.liked_posts.remove(post['id'])
                    st.rerun()
                
                st.divider()

elif choice == "Edit Bio":
    st.subheader("Update Your Profile")
    if not st.session_state.users:
        st.warning("No users found.")
    else:
        edit_user = st.selectbox("Select your username", list(st.session_state.users.keys()))
        if edit_user:
            new_bio = st.text_area("New Bio", value=st.session_state.users[edit_user]['bio'])
            if st.button("Update", use_container_width=True):
                st.session_state.users[edit_user]['bio'] = new_bio
                st.success("Bio updated!")
